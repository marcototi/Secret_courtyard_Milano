name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Esegui test giornalieri alle 2:00 UTC
    - cron: '0 2 * * *'

jobs:
  validate-html:
    name: Validate HTML
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install HTML validator
      run: npm install -g html-validator-cli

    - name: Validate HTML files
      run: |
        # Trova tutti i file HTML (esclusi backup)
        find website -name "*.html" -not -name "*.backup" | while read file; do
          echo "Validating: $file"
          html-validator --file "$file" --verbose || true
        done

  validate-css:
    name: Validate CSS
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install CSS validator
      run: npm install -g css-validator

    - name: Validate CSS files
      run: |
        # Valida il file CSS principale
        css-validator website/assets/css/main.css || true

        # Valida tutti i moduli CSS
        find website/assets/css/modules -name "*.css" | while read file; do
          echo "Validating: $file"
          css-validator "$file" || true
        done

  accessibility-test:
    name: Accessibility Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install pa11y accessibility tool
      run: npm install -g pa11y-ci

    - name: Run accessibility tests
      run: |
        # Crea configurazione pa11y
        cat > pa11y-ci.json << EOF
        {
          "defaults": {
            "timeout": 30000,
            "threshold": 5,
            "standard": "WCAG2AA",
            "ignore": [
              "notice",
              "warning"
            ]
          },
          "urls": [
            "website/index.html",
            "website/pages/la-casa.html",
            "website/pages/mobilita.html",
            "website/pages/scopri-milano.html",
            "website/pages/la-ristrutturazione.html"
          ]
        }
        EOF

        # Esegui test di accessibilità
        pa11y-ci --config pa11y-ci.json

  performance-test:
    name: Performance Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Lighthouse CI
      run: npm install -g @lhci/cli

    - name: Run Lighthouse CI
      run: |
        # Crea server HTTP locale per test
        npx serve website -p 8080 &
        SERVER_PID=$!
        sleep 5

        # Esegui Lighthouse CI
        lhci autorun --collect.url="http://localhost:8080" || true

        # Termina server
        kill $SERVER_PID

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run security scan with OWASP ZAP
      uses: zaproxy/action-full-scan@v0.10.0
      with:
        target: 'http://localhost:8080'
        rules_file_name: '.zap/rules.tsv'
        cmd_options: '-a'

    - name: Start local server for ZAP
      run: |
        npx serve website -p 8080 &
        echo $! > server.pid
        sleep 10

    - name: Stop local server
      if: always()
      run: |
        if [ -f server.pid ]; then
          kill $(cat server.pid) || true
          rm server.pid
        fi

  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to Netlify Preview
      uses: nwtgck/actions-netlify@v3.0
      with:
        publish-dir: './website'
        production-branch: main
        github-token: ${{ secrets.GITHUB_TOKEN }}
        deploy-message: "Deploy from GitHub Actions"
        enable-pull-request-comment: true
        enable-commit-comment: true
        overwrites-pull-request-comment: true
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [validate-html, validate-css, accessibility-test, performance-test, security-scan]
    if: always()

    steps:
    - name: Send notification
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          }).catch(() => ({ data: null }));

          const jobStatuses = {
            'validate-html': '${{ needs.validate-html.result }}',
            'validate-css': '${{ needs.validate-css.result }}',
            'accessibility-test': '${{ needs.accessibility-test.result }}',
            'performance-test': '${{ needs.performance-test.result }}',
            'security-scan': '${{ needs.security-scan.result }}'
          };

          const allPassed = Object.values(jobStatuses).every(status => status === 'success');
          const hasFailures = Object.values(jobStatuses).some(status => status === 'failure');

          let message = `## CI/CD Pipeline Results\n\n`;
          message += `**Status:** ${allPassed ? '✅ All checks passed' : hasFailures ? '❌ Some checks failed' : '⚠️ Some checks had issues'}\n\n`;

          message += `### Job Results:\n`;
          for (const [job, status] of Object.entries(jobStatuses)) {
            const emoji = status === 'success' ? '✅' : status === 'failure' ? '❌' : '⚠️';
            message += `- ${emoji} ${job}: ${status}\n`;
          }

          message += `\n**Commit:** ${{ github.sha }}\n`;
          message += `**Triggered by:** ${{ github.actor }}\n`;
          message += `**Workflow:** ${{ github.workflow }}\n`;

          if (pr) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
          }